name: Download fonts
on:
  workflow_dispatch:
  schedule:
    - cron: "0 19 * * *"
  push:
    branches:
      - main
    paths-ignore:
      - "README.md"

jobs:
  Update:
    runs-on: ubuntu-latest
    steps:
    - name: Clone Repository
      uses: actions/checkout@main

    - name: Download MiSans
      run: |
        echo "update_version=$(date -d '+8 hours' +%Y-%m-%d)" >> ${GITHUB_ENV}
        mkdir -p ./tmp/ ./MiSans/ ./FiraCode/ ./Sarasa/ ./LXGW/ ./Source/
        mkdir -p ./tmp/zip/MiSans/
        wget -P ./tmp/ https://hyperos.mi.com/font-download/MiSans.zip
        unzip -o ./tmp/MiSans.zip -d ./tmp/
        mv -f ./tmp/MiSans/otf/MiSans-Bold.otf "./tmp/zip/MiSans/MiSans Bold.otf"
        mv -f ./tmp/MiSans/otf/MiSans-Light.otf "./tmp/zip/MiSans/MiSans Light.otf"
        mv -f ./tmp/MiSans/otf/MiSans-Regular.otf "./tmp/zip/MiSans/MiSans.otf"

    - name: zip directory to zip
      uses: montudor/action-zip@v1
      with:
        args: zip -qq -r MiSans.zip ./tmp/zip/MiSans/

    - name: Move files
      run: |
        cp -f ./MiSans.zip ./MiSans/
        rm -rf ./tmp*

    - name: Commit and push `MiSans`
      run: |
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        git add . && git commit -m "MiSans 字体更新于 ${update_version}" || exit 0
        git push -f

    - name: Purge jsDelivr CDN
      run: |
        cd ./MiSans/ || exit 1
        for file in $(ls); do
          curl -i "https://purge.jsdelivr.net/gh/${{ github.repository }}@main/MiSans/${file}"
        done
